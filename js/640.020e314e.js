"use strict";(globalThis["webpackChunkiotapp"]=globalThis["webpackChunkiotapp"]||[]).push([[640],{1640:(e,t,a)=>{a.r(t),a.d(t,{default:()=>B});var s=a(1758),i=a(8790);const r={class:"q-pa-md bg-dark text-white"},o={class:"row items-center"},n={key:0,class:"text-center q-pa-md"},l={key:1},d={class:"text-h6"},c={class:"row q-gutter-sm"},g={class:"row items-center q-gutter-sm"},m={class:"col q-mb-none"},u={class:"row items-center q-gutter-sm"},p={class:"col q-mb-none"},h={class:"row q-gutter-sm q-mt-sm"},v={class:"row items-center q-gutter-sm"},b={class:"col q-mb-none"},y={class:"row items-center q-gutter-sm"},k={class:"col q-mb-none"},f={key:0,style:{height:"300px","margin-top":"16px"}},L={key:1,class:"text-negative q-mt-md"},q={class:"row q-mb-md q-gutter-sm"},w={key:2};function _(e,t,a,_,C,F){const S=(0,s.g2)("q-icon"),D=(0,s.g2)("q-space"),x=(0,s.g2)("q-card"),A=(0,s.g2)("l-tile-layer"),O=(0,s.g2)("l-marker"),$=(0,s.g2)("l-map"),N=(0,s.g2)("q-btn"),z=(0,s.g2)("q-table");return(0,s.uX)(),(0,s.CE)(s.FK,null,[t[9]||(t[9]=(0,s.Lk)("link",{href:"https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined",rel:"stylesheet"},null,-1)),(0,s.Lk)("div",r,[(0,s.Lk)("div",o,[(0,s.bF)(S,{class:"col-1",color:"white",name:"arrow_back_ios",onClick:t[0]||(t[0]=t=>e.$router.back()),clickable:"",size:"30px"}),(0,s.bF)(D),t[2]||(t[2]=(0,s.eW)(" Device Detail ",-1))]),C.loadingDetail?((0,s.uX)(),(0,s.CE)("div",n)):C.device?((0,s.uX)(),(0,s.CE)("div",l,[(0,s.bF)(x,{class:(0,i.C4)([F.getFireBadge(C.device.data),"q-mb-md q-pa-md cardd q-mt-md"])},{default:(0,s.k6)(()=>[(0,s.Lk)("div",d,[t[3]||(t[3]=(0,s.Lk)("strong",null,"Device name:",-1)),(0,s.eW)(" "+(0,i.v_)(C.device.device_name||"-"),1)]),(0,s.Lk)("div",null,[t[4]||(t[4]=(0,s.Lk)("strong",null,"MAC Address:",-1)),(0,s.eW)(" "+(0,i.v_)(C.device.mac_address),1)])]),_:1},8,["class"]),(0,s.bF)(x,{class:"q-mb-md bg-black q-pa-md cardd q-mt-md"},{default:(0,s.k6)(()=>[t[5]||(t[5]=(0,s.Lk)("p",null,"Current Data",-1)),(0,s.Lk)("div",c,[(0,s.bF)(x,{class:(0,i.C4)([F.getTempBadge(C.device.data),"col q-pa-md cardd"])},{default:(0,s.k6)(()=>[(0,s.Lk)("div",g,[(0,s.bF)(S,{class:"col",name:"device_thermostat",size:"40px"}),(0,s.Lk)("p",m,(0,i.v_)(F.getTemperature(C.device.data))+" °C",1)])]),_:1},8,["class"]),(0,s.bF)(x,{class:(0,i.C4)([F.getFireBadge(C.device.data),"col q-pa-md cardd"])},{default:(0,s.k6)(()=>[(0,s.Lk)("div",u,[(0,s.bF)(S,{class:"col",name:"local_fire_department",size:"40px"}),(0,s.Lk)("p",p,(0,i.v_)(F.getFirestate(C.device.data)),1)])]),_:1},8,["class"])]),(0,s.Lk)("div",h,[(0,s.bF)(x,{class:(0,i.C4)([F.getSmokebadge(C.device.data),"col q-pa-md cardd"])},{default:(0,s.k6)(()=>[(0,s.Lk)("div",v,[(0,s.bF)(S,{class:"col material-symbols-outlined",name:"detector_smoke",size:"40px"}),(0,s.Lk)("p",b,(0,i.v_)(F.getSmokestate(C.device.data)),1)])]),_:1},8,["class"]),(0,s.bF)(x,{class:(0,i.C4)([F.getSirenbadge(C.device.data),"col q-pa-md cardd"])},{default:(0,s.k6)(()=>[(0,s.Lk)("div",y,[(0,s.bF)(S,{class:"col material-symbols-outlined",name:"siren",size:"40px"}),(0,s.Lk)("p",k,(0,i.v_)(F.getSirenstate(C.device.data)),1)])]),_:1},8,["class"])])]),_:1,__:[5]}),(0,s.bF)(x,{class:"q-mb-md bg-black q-pa-md cardd"},{default:(0,s.k6)(()=>[t[6]||(t[6]=(0,s.Lk)("p",null,"Device Location",-1)),F.hasLocation?((0,s.uX)(),(0,s.CE)("div",f,[(0,s.bF)($,{zoom:C.zoom,center:F.mapCenter,style:{height:"100%",width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(A,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),(0,s.bF)(O,{"lat-lng":F.mapCenter},null,8,["lat-lng"])]),_:1},8,["zoom","center"])])):((0,s.uX)(),(0,s.CE)("div",L," Lokasi tidak tersedia (latitude/longitude kosong). "))]),_:1,__:[6]}),(0,s.bF)(x,{class:"q-mb-md bg-black q-pa-md cardd"},{default:(0,s.k6)(()=>[(0,s.bF)(x,{class:"q-mb-sm bg-black cardd"},{default:(0,s.k6)(()=>[t[7]||(t[7]=(0,s.Lk)("p",null,"Device History",-1)),(0,s.Lk)("div",q,[(0,s.bF)(N,{class:"col button-cuy text-capitalize",label:"Delete History",color:"negative",unelevated:"",onClick:F.onDeleteHistory,loading:C.loadingLogs},null,8,["onClick","loading"]),(0,s.bF)(N,{class:"col button-cuy text-capitalize",label:"Export Excel",color:"primary",unelevated:"",onClick:F.exportExcel,loading:C.loadingLogs},null,8,["onClick","loading"])])]),_:1,__:[7]}),(0,s.bF)(z,{rows:C.deviceLogs,columns:C.columns,"row-key":"created_at",loading:C.loadingLogs,flat:"",pagination:C.pagination,"onUpdate:pagination":t[1]||(t[1]=e=>C.pagination=e),onRequest:F.onRequest,class:"bg-dark text-white"},null,8,["rows","columns","loading","pagination","onRequest"])]),_:1})])):((0,s.uX)(),(0,s.CE)("div",w,t[8]||(t[8]=[(0,s.Lk)("div",{class:"text-center q-pa-md"},"Device not found.",-1)])))])],64)}a(3437);var C=a(7024);const F={name:"DEVICEDETAIL",components:{LMap:C.Do,LTileLayer:C.a,LMarker:C.li},data(){return{loadingDetail:!1,device:null,intervalId:null,deviceLogs:[],loadingLogs:!1,zoom:15,pagination:{page:1,rowsPerPage:25,rowsNumber:0,sortBy:"created_at",descending:!0},columns:[{name:"log_value",label:"Temperature (°C)",field:"log_value",format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.temperature?a.temperature+" °C":"-"}catch{return"-"}}},{name:"log_value",label:"Status",field:"log_value",format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.status?a.status:"-"}catch{return"-"}}},{name:"created_at",label:"Created At (WIB)",field:"created_at",format:e=>{if(!e)return"-";try{const t=new Date(e);return new Intl.DateTimeFormat("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Jakarta"}).format(t)}catch{return e}},sortable:!0}]}},computed:{macAddress(){return this.$route.params.mac_address},hasLocation(){return this.device&&null!=this.device.latitude&&null!=this.device.longitude},mapCenter(){return this.hasLocation?[this.device.latitude,this.device.longitude]:[0,0]}},mounted(){this.fetchDeviceDetail(),console.log("device:",this.device),this.fetchLogs(),this.intervalId=setInterval(()=>{this.fetchDeviceDetail()},500)},beforeUnmount(){clearInterval(this.intervalId)},watch:{"$route.params.mac_address"(e,t){e!==t&&(this.fetchDeviceDetail(),this.fetchLogs())}},methods:{async fetchDeviceDetail(){try{const e=localStorage.getItem("token"),t=await this.$api.get(`/devices/realtimes/${this.macAddress}`,{headers:{Authorization:`Bearer ${e}`}});if(t.data&&t.data.data&&0!==t.data.data.length){const e=t.data.data[0];JSON.stringify(this.device)!==JSON.stringify(e)&&(this.device=e)}else null!==this.device&&(this.device=null),this.$q.notify({type:"warning",message:"Data device tidak ditemukan"});console.log("Device detail response:",t.data)}catch(e){null!==this.device&&(this.device=null),this.$q.notify({type:"negative",message:"Gagal memuat detail device",position:"top"})}},async exportExcel(){this.loadingLogs=!0;try{const e=localStorage.getItem("token"),t=await this.$api.get("/device-logs/export-excel",{responseType:"blob",headers:{Authorization:`Bearer ${e}`}}),a=window.URL.createObjectURL(new Blob([t.data])),s=document.createElement("a");s.href=a,s.setAttribute("download","device_logs.xlsx"),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a)}catch(e){this.$q.notify({type:"negative",message:"Gagal mengunduh file Excel"}),console.error(e)}finally{this.loadingLogs=!1}},async fetchLogs(){if(this.macAddress){this.loadingLogs=!0;try{const e=localStorage.getItem("token"),{page:t,rowsPerPage:a,sortBy:s,descending:i}=this.pagination,r=i?"desc":"asc",o=await this.$api.get(`/device-logs/logs/${this.macAddress}`,{params:{page:t,limit:a,sortBy:s,order:r},headers:{Authorization:`Bearer ${e}`}});this.deviceLogs=Array.isArray(o.data.logs)?o.data.logs:[],this.pagination.rowsNumber=o.data.total||0}catch(e){this.$q.notify({type:"negative",message:"Failed to load device logs",position:"top"})}finally{this.loadingLogs=!1}}},async onRequest(e){this.pagination=e.pagination,await this.fetchLogs()},getTemperature(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.temperature?parseFloat(t.temperature).toFixed(2):"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getFirestate(e){if(!e)return"-";if(e.data){if("string"!==typeof e.data)return"object"===typeof e.data&&null!==e.data&&void 0!==e.data.api?e.data.api:"-";try{const t=JSON.parse(e.data);return void 0!==t.api?t.api:"-"}catch(e){return console.error("JSON parse error:",e),"-"}}else if(void 0!==e.api)return e.api;return"-"},getTempBadge(e){const t=this.getTemperature(e);return t<40?"bg-green":t<60?"bg-orange":"bg-negative"},getFireBadge(e){const t=this.getFirestate(e);return"fire detected!"===t.toLowerCase()?"bg-negative":"no fire"===t.toLowerCase()?"bg-green":"bg-grey"},getSmokestate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.smoke?t.smoke:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSmokebadge(e){const t=this.getSmokestate(e);return"smoke detected!"===t.toLowerCase()?"bg-negative":"no smoke"===t.toLowerCase()?"bg-green":"bg-grey"},getSirenstate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.relay?t.relay:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSirenbadge(e){const t=this.getSirenstate(e);return"ON"===t.toUpperCase()?"bg-negative":"OFF"===t.toUpperCase()?"bg-green":"bg-grey"},async onDeleteHistory(){if(this.device&&this.device.mac_address)try{this.loadingLogs=!0,await this.$api.delete(`/device-logs/logs/${this.device.mac_address}`),this.$q.notify({type:"positive",message:"Device history deleted successfully"}),this.deviceLogs=[]}catch(e){this.$q.notify({type:"negative",message:"Failed to delete device history"})}finally{this.loadingLogs=!1,await this.fetchLogs()}else this.$q.notify({type:"warning",message:"No device selected to delete history"})}}};var S=a(2807),D=a(492),x=a(3676),A=a(564),O=a(3316),$=a(1693),N=a(528),z=a(8582),E=a.n(z);const J=(0,S.A)(F,[["render",_]]),B=J;E()(F,"components",{QIcon:D.A,QSpace:x.A,QSpinner:A.A,QCard:O.A,QBtn:$.A,QTable:N.A})}}]);