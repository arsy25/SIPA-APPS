"use strict";(globalThis["webpackChunkiotapp"]=globalThis["webpackChunkiotapp"]||[]).push([[50],{50:(e,t,a)=>{a.r(t),a.d(t,{default:()=>H});var s=a(1758),i=a(8790);const o={class:"row q-gutter-sm"},r={class:"row"},n={class:"text-h6 text-white q-mb-sm"},l={class:"text-h6 text-white q-mb-sm"},d={class:"q-mt-md",style:{height:"200px","max-width":"600%"}},c={class:"row q-gutter-sm"},g={class:"q-mb-none text-center"},u={class:"q-mb-none text-center"},h={class:"row q-gutter-sm q-mt-sm"},m={class:"row justify-between items-center"},p={class:"text-justify"},v={class:"row q-gutter-sm"},f={class:"row"},k={class:"text-h6 text-white q-mb-sm"},y={class:"text-h6 text-white q-mb-sm"},w={class:"q-mt-md",style:{height:"200px","max-width":"100%"}},b={class:"row q-gutter-sm"},_={class:"q-mb-none text-center"},F={class:"q-mb-none text-center"},A={class:"row q-gutter-sm q-mt-sm"},L={class:"row justify-between items-center"},q={class:"text-justify"};function D(e,t,a,D,x,I){const S=(0,s.g2)("l-tile-layer"),N=(0,s.g2)("l-marker"),C=(0,s.g2)("l-map"),T=(0,s.g2)("q-icon"),O=(0,s.g2)("q-card"),z=(0,s.g2)("q-btn"),$=(0,s.g2)("q-card-section"),J=(0,s.g2)("q-page"),P=(0,s.g2)("q-tooltip"),B=(0,s.g2)("q-toggle");return e.$q.platform.is.mobile?((0,s.uX)(),(0,s.Wv)(J,{key:0,class:"q-pa-md bg-dark"},{default:(0,s.k6)(()=>[t[2]||(t[2]=(0,s.Lk)("p",{class:"textt text-white text-h4"},"Monitoring",-1)),(0,s.Lk)("div",o,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(x.devices,e=>((0,s.uX)(),(0,s.Wv)(O,{class:"cardd bg-dark q-pa-md",key:e.mac_address},{default:(0,s.k6)(()=>[(0,s.Lk)("div",r,[(0,s.Lk)("div",null,[(0,s.Lk)("div",n,(0,i.v_)(e.device_name),1),(0,s.Lk)("div",l,[(0,s.Lk)("div",d,[(0,s.bF)(C,{zoom:10,center:[parseFloat(e.latitude),parseFloat(e.longitude)],style:{height:"100%",width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(S,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(0,s.bF)(N,{"lat-lng":[parseFloat(e.latitude),parseFloat(e.longitude)]},null,8,["lat-lng"])]),_:2},1032,["center"])])]),(0,s.Lk)("div",c,[(0,s.bF)(O,{class:(0,i.C4)([I.getTempBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(T,{name:"device_thermostat",size:"40px"}),(0,s.Lk)("p",g,(0,i.v_)(I.getTemperature(e.data))+"°C ",1)]),_:2},1032,["class"]),(0,s.bF)(O,{class:(0,i.C4)([I.getFireBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(T,{name:"local_fire_department",size:"40px"}),(0,s.Lk)("p",u,(0,i.v_)(I.getFirestate(e.data)),1)]),_:2},1032,["class"])]),(0,s.Lk)("div",h,[(0,s.bF)(z,{label:"See details",color:"dark",unelevated:"",class:"col button-cuy text-capitalize text-white",onClick:t=>I.goToDetailPage(e.mac_address)},null,8,["onClick"]),(0,s.bF)(z,{label:"Ask AI Assistant",unelevated:"",color:"dark",class:"col button-cuy text-capitalize text-white",onClick:t=>I.askAIForDevice(e.mac_address),loading:x.loadingDevices[e.mac_address]||!1,style:{width:"290px"}},null,8,["onClick","loading"])])])]),x.answers[e.mac_address]?((0,s.uX)(),(0,s.Wv)($,{key:0},{default:(0,s.k6)(()=>[(0,s.bF)(O,{class:"bg-dark q-pa-md text-white"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",m,[t[1]||(t[1]=(0,s.Lk)("strong",{class:"text-h6"},"AI RESPONSE",-1)),(0,s.bF)(z,{dense:"",flat:"",icon:"close",color:"white",onClick:t=>I.removeAnswer(e.mac_address),"aria-label":"Close answer"},null,8,["onClick"])]),(0,s.Lk)("div",p,(0,i.v_)(x.answers[e.mac_address]),1)]),_:2},1024)]),_:2},1024)):(0,s.Q3)("",!0)]),_:2},1024))),128))])]),_:1,__:[2]})):((0,s.uX)(),(0,s.Wv)(J,{key:1,class:"q-pa-md bg-dark"},{default:(0,s.k6)(()=>[(0,s.bF)(B,{modelValue:x.audioAllowed,"onUpdate:modelValue":t[0]||(t[0]=e=>x.audioAllowed=e),label:"Activate the siren notification",class:"text-white",color:"red",onInput:I.onToggleAudio},{default:(0,s.k6)(()=>[(0,s.bF)(P,null,{default:(0,s.k6)(()=>t[3]||(t[3]=[(0,s.eW)("Turn up your volume",-1)])),_:1,__:[3]})]),_:1},8,["modelValue","onInput"]),(0,s.Lk)("div",v,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(x.devices,e=>((0,s.uX)(),(0,s.Wv)(O,{class:"cardd bg-dark q-pa-md",key:e.mac_address},{default:(0,s.k6)(()=>[(0,s.Lk)("div",f,[(0,s.Lk)("div",null,[(0,s.Lk)("div",k,(0,i.v_)(e.device_name),1),(0,s.Lk)("div",y,[(0,s.Lk)("div",w,[(0,s.bF)(C,{zoom:10,center:[parseFloat(e.latitude),parseFloat(e.longitude)],style:{height:"100%",width:"100%"}},{default:(0,s.k6)(()=>[(0,s.bF)(S,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(0,s.bF)(N,{"lat-lng":[parseFloat(e.latitude),parseFloat(e.longitude)]},null,8,["lat-lng"])]),_:2},1032,["center"])])]),(0,s.Lk)("div",b,[(0,s.bF)(O,{class:(0,i.C4)([I.getTempBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(T,{name:"device_thermostat",size:"40px"}),(0,s.Lk)("p",_,(0,i.v_)(I.getTemperature(e.data))+"°C ",1)]),_:2},1032,["class"]),(0,s.bF)(O,{class:(0,i.C4)([I.getFireBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(T,{name:"local_fire_department",size:"40px"}),(0,s.Lk)("p",F,(0,i.v_)(I.getFirestate(e.data)),1)]),_:2},1032,["class"])]),(0,s.Lk)("div",A,[(0,s.bF)(z,{label:"See details",color:"dark",unelevated:"",class:"col button-cuy text-capitalize text-white",onClick:t=>I.goToDetailPage(e.mac_address)},null,8,["onClick"]),(0,s.bF)(z,{label:"Ask AI Assistant",unelevated:"",color:"dark",class:"col button-cuy text-capitalize text-white",onClick:t=>I.askAIForDevice(e.mac_address),loading:x.loadingDevices[e.mac_address]||!1,style:{width:"290px"}},null,8,["onClick","loading"])])])]),x.answers[e.mac_address]?((0,s.uX)(),(0,s.Wv)($,{key:0},{default:(0,s.k6)(()=>[(0,s.bF)(O,{class:"bg-dark q-pa-md text-white"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",L,[t[4]||(t[4]=(0,s.Lk)("strong",{class:"text-h6"},"AI RESPONSE",-1)),(0,s.bF)(z,{dense:"",flat:"",icon:"close",color:"white",onClick:t=>I.removeAnswer(e.mac_address),"aria-label":"Close answer"},null,8,["onClick"])]),(0,s.Lk)("div",q,(0,i.v_)(x.answers[e.mac_address]),1)]),_:2},1024)]),_:2},1024)):(0,s.Q3)("",!0)]),_:2},1024))),128))])]),_:1}))}a(310),a(2203),a(95);var x=a(7024);const I={name:"UserDevices",components:{LMap:x.Do,LTileLayer:x.a,LMarker:x.li},data(){return{loadingLogs:!1,showDialog:!1,userPrompt:"",answers:{},loadingDevices:{},loading:!1,pagination:{page:1,rowsPerPage:25,rowsNumber:0,sortBy:"",descending:!1},audioAllowed:!1,devices:[],userId:null,detailDialog:!1,historyDialog:!1,selectedDevice:null,selectedHistoryDevice:null,zoom:15,status:"",deviceLogs:[],columns:[{name:"log_value",label:"Temperature (°C)",field:"log_value",sortable:!0,format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.temperature?a.temperature+" °C":"-"}catch{return"-"}}},{name:"log_value",label:"Status",field:"log_value",format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.status?a.status:"-"}catch{return"-"}}},{name:"created_at",label:"Created At (WIB)",field:"created_at",format:e=>{if(!e)return"-";try{const t=new Date(e);return new Intl.DateTimeFormat("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Jakarta"}).format(t)}catch{return e}},sortable:!0}]}},watch:{status(e){this.showBrowserNotification("Test","Ini push notifikasi!")}},mounted(){const e=JSON.parse(localStorage.getItem("user"));this.userId=e?.id_user||null,this.fetchDevices(),this.fetchAndAsk(),this.requestNotificationPermission(),this.intervalId=setInterval(()=>{this.fetchDevices()},2e3)},beforeUnmount(){clearInterval(this.intervalId)},computed:{hasLocation(){return this.selectedDevice&&null!=this.selectedDevice.latitude&&null!=this.selectedDevice.longitude},mapCenter(){return this.hasLocation?[this.selectedDevice.latitude,this.selectedDevice.longitude]:[0,0]}},methods:{goToDetailPage(e){this.$router.push({name:"DEVICEDETAIL",params:{mac_address:e}})},async fetchDevices(){if(this.userId)try{const e=localStorage.getItem("token"),t=await this.$api.get("/devices/realtime/all/devices",{headers:{Authorization:`Bearer ${e}`}});this.devices=t.data.data||[],this.devices.forEach(e=>{e&&this.requestNotificationPermission(e)})}catch(e){this.$q.notify({type:"negative",message:"Failed to load devices",position:"top"})}else this.devices=[]},async askAIForDevice(e){const t=this.devices.find(t=>t.mac_address===e);if(t){this.loadingDevices[e]=!0,this.answers[e]="";try{const a="object"===typeof t.data?JSON.stringify(t.data):t.data,s=`\nHere is the sensor data from an IoT device: ${a}\n\nPlease do the following:\n1. Analyze the data thoroughly for any signs of fire, smoke, or other hazards.\n2. Provide a clear and concise explanation regarding any risks detected.\n3. Suggest appropriate actions or solutions to mitigate these risks.\n\nLimit your entire response to between 300 and 400 characters only.\n`,i=await this.$api.post("/openai/ask",{prompt:s});this.answers[e]=i.data.answer}catch(t){this.answers[e]="Gagal mendapatkan jawaban AI.",console.error(t)}finally{this.loadingDevices[e]=!1}}},async fetchAndAsk(){await this.fetchDevices(),await this.askAIOnDevices()},onToggleAudio(e){e?this.$q.notify({message:"Suara notifikasi telah diaktifkan",color:"positive",position:"top"}):this.$q.notify({message:"Suara notifikasi dimatikan",color:"negative",position:"top"})},async loadDataAndStartInterval(){await this.fetchDevices(),this.intervalId=setInterval(()=>{this.fetchDevices()},2e3)},beforeUnmount(){clearInterval(this.intervalId)},openDetail(e){this.selectedDevice=e,this.detailDialog=!0},async openHistory(e){this.selectedHistoryDevice=e,this.historyDialog=!0,this.pagination.page=1,await this.fetchLogs()},async fetchLogs(){this.loadingLogs=!0;try{const e=localStorage.getItem("token"),{page:t,rowsPerPage:a,sortBy:s,descending:i}=this.pagination,o=i?"desc":"asc",r=await this.$api.get(`/device-logs/logs/${this.selectedHistoryDevice.mac_address}`,{params:{page:t,limit:a,sortBy:s,order:o},headers:{Authorization:`Bearer ${e}`}});this.deviceLogs=Array.isArray(r.data.logs)?r.data.logs:[],this.pagination.rowsNumber=r.data.total||0}catch(e){console.error("Failed to load device logs",e)}finally{this.loadingLogs=!1}},async onRequest(e){this.pagination=e.pagination,await this.fetchLogs()},async onDeleteHistory(){if(this.selectedHistoryDevice&&this.selectedHistoryDevice.mac_address)try{this.loadingLogs=!0,await this.$api.delete(`/device-logs/logs/${this.selectedHistoryDevice.mac_address}`),this.$q.notify({type:"positive",message:"Device history deleted successfully"}),this.deviceLogs=[]}catch(e){this.$q.notify({type:"negative",message:"Failed to delete device history"})}finally{this.loadingLogs=!1}else this.$q.notify({type:"warning",message:"No device selected to delete history"})},removeAnswer(e){delete this.answers[e],this.answers={...this.answers}},getTemperature(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.temperature?parseFloat(t.temperature).toFixed(2):"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getTempBadge(e){const t=this.getTemperature(e);return t<40?"bg-green":t<60?"bg-orange":"bg-negative"},getFireNotif(e){if(!e||!e.data||!e.data.data)return"-";try{const t="string"===typeof e.data.data?JSON.parse(e.data.data):e.data.data;return console.log(t.api),void 0!==t.api?t.api:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getFirestate(e){if(!e)return"-";if(e.data){if("string"!==typeof e.data)return"object"===typeof e.data&&null!==e.data&&void 0!==e.data.api?e.data.api:"-";try{const t=JSON.parse(e.data);return void 0!==t.api?t.api:"-"}catch(e){return console.error("JSON parse error:",e),"-"}}else if(void 0!==e.api)return e.api;return"-"},getFireBadge(e){const t=this.getFirestate(e);return"fire detected!"===t?"bg-negative":"no fire"===t?"bg-green":"bg-grey"},getSirenstate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.relay?t.relay:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSirenbadge(e){const t=this.getSirenstate(e);return"ON"===t?"bg-negative":"OFF"===t?"bg-green":"bg-grey"},getSmokestate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.smoke?t.smoke:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSmokebadge(e){const t=this.getSmokestate(e);return"smoke detected!"===t?"bg-negative":"no smoke"===t?"bg-green":"bg-grey"},async requestNotificationPermission(e){if(e&&"Notification"in window){const t=await Notification.requestPermission();if("granted"===t){const t=this.getFireNotif(e),a=t.toString().toLowerCase().trim();if("fire detected!"===a||"fire hazard"===a){const t=`🔥 Fire detected pada device: ${e.device_name||"Unknown"}. Segera ambil tindakan!`;if(new Notification("ALERT NOTIFICATION",{body:t,icon:"/icons/icon-192x192.png"}),this.audioAllowed){const e=new Audio("alarm.mp3");e.play().catch(e=>{console.warn("Audio play gagal:",e)})}}}else console.warn("Izin notifikasi ditolak")}},showBrowserNotification(e,t){"Notification"in window&&"granted"===Notification.permission&&new Notification(e,{body:t})}}};var S=a(2807),N=a(7716),C=a(3316),T=a(492),O=a(1693),z=a(4189),$=a(6908),J=a(3954),P=a(7410),B=a(8582),E=a.n(B);const Q=(0,S.A)(I,[["render",D]]),H=Q;E()(I,"components",{QPage:N.A,QCard:C.A,QIcon:T.A,QBtn:O.A,QCardSection:z.A,QToggle:$.A,QBadge:J.A,QTooltip:P.A})}}]);