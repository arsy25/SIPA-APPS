"use strict";(globalThis["webpackChunkiotapp"]=globalThis["webpackChunkiotapp"]||[]).push([[283],{9283:(e,t,a)=>{a.r(t),a.d(t,{default:()=>J});var s=a(1758),i=a(8790);const r={class:"row q-pa-md"},o={class:"row"},n={class:"text-h6 text-white q-mb-sm"},c={class:"row q-gutter-sm"},d={class:"q-mb-none text-center"},l={class:"q-mb-none text-center"},g={class:"row q-gutter-sm q-mt-sm"},h={class:"row justify-between items-center"},u={class:"text-justify"},m={class:"row q-pa-md"},p={class:"q-gutter-sm"},v={class:"row"},f={class:"text-h6 text-white q-mb-sm"},k={class:"row q-gutter-sm"},y={class:"q-mb-none text-center"},b={class:"q-mb-none text-center"},w={class:"row q-gutter-sm q-mt-sm"},_={class:"row justify-between items-center"},x={class:"text-justify"};function L(e,t,a,L,D,q){const A=(0,s.g2)("q-icon"),F=(0,s.g2)("q-card"),S=(0,s.g2)("q-btn"),I=(0,s.g2)("q-card-section"),N=(0,s.g2)("q-page");return e.$q.platform.is.mobile?((0,s.uX)(),(0,s.Wv)(N,{key:0,class:"q-pa-md bg-black"},{default:(0,s.k6)(()=>[t[2]||(t[2]=(0,s.Lk)("p",{class:"textt text-white text-h4"},"Dashboard",-1)),(0,s.bF)(F,{class:"cardd q-mb-md bg-negative"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",r,[(0,s.bF)(A,{class:"col-4",size:"70px",name:"local_fire_department",color:"white"}),t[0]||(t[0]=(0,s.Lk)("div",{class:"col q-ml-md"},[(0,s.Lk)("div",{class:"text-h6 text-white"},"Fire Monitoring"),(0,s.Lk)("div",{class:"text-subtitle1 text-white"},[(0,s.Lk)("b",{class:"text-h5"},"1"),(0,s.eW)(" Active ")])],-1))])]),_:1}),t[3]||(t[3]=(0,s.Lk)("p",{class:"textt text-white text-h5"},"Devices",-1)),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(D.devices,e=>((0,s.uX)(),(0,s.Wv)(F,{class:"cardd bg-dark q-pa-md",key:e.mac_address},{default:(0,s.k6)(()=>[(0,s.Lk)("div",o,[(0,s.Lk)("div",null,[(0,s.Lk)("div",n,(0,i.v_)(e.device_name),1),(0,s.Lk)("div",c,[(0,s.bF)(F,{class:(0,i.C4)([q.getTempBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(A,{name:"device_thermostat",size:"40px"}),(0,s.Lk)("p",d,(0,i.v_)(q.getTemperature(e.data))+"°C ",1)]),_:2},1032,["class"]),(0,s.bF)(F,{class:(0,i.C4)([q.getFireBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(A,{name:"local_fire_department",size:"40px"}),(0,s.Lk)("p",l,(0,i.v_)(q.getFirestate(e.data)),1)]),_:2},1032,["class"])]),(0,s.Lk)("div",g,[(0,s.bF)(S,{label:"See details",color:"dark",unelevated:"",class:"col button-cuy text-capitalize text-white",onClick:t=>q.goToDetailPage(e.mac_address)},null,8,["onClick"]),(0,s.bF)(S,{label:"Ask AI Assistant",unelevated:"",color:"dark",class:"col button-cuy text-capitalize text-white",onClick:t=>q.askAIForDevice(e.mac_address),loading:D.loadingDevices[e.mac_address]||!1,style:{width:"290px"}},null,8,["onClick","loading"])])])]),D.answers[e.mac_address]?((0,s.uX)(),(0,s.Wv)(I,{key:0},{default:(0,s.k6)(()=>[(0,s.bF)(F,{class:"bg-dark q-pa-md text-white"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",h,[t[1]||(t[1]=(0,s.Lk)("strong",{class:"text-h6"},"AI RESPONSE",-1)),(0,s.bF)(S,{dense:"",flat:"",icon:"close",color:"white",onClick:t=>q.removeAnswer(e.mac_address),"aria-label":"Close answer"},null,8,["onClick"])]),(0,s.Lk)("div",u,(0,i.v_)(D.answers[e.mac_address]),1)]),_:2},1024)]),_:2},1024)):(0,s.Q3)("",!0)]),_:2},1024))),128))]),_:1,__:[2,3]})):((0,s.uX)(),(0,s.Wv)(N,{key:1,class:"q-pa-md bg-black"},{default:(0,s.k6)(()=>[t[6]||(t[6]=(0,s.Lk)("p",{class:"textt text-white text-h4"},"Dashboard",-1)),(0,s.bF)(F,{class:"cardd q-mb-md bg-negative"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",m,[(0,s.bF)(A,{class:"col-4",size:"70px",name:"local_fire_department",color:"white"}),t[4]||(t[4]=(0,s.Lk)("div",{class:"col q-ml-md"},[(0,s.Lk)("div",{class:"text-h6 text-white"},"Fire Monitoring"),(0,s.Lk)("div",{class:"text-subtitle1 text-white"},[(0,s.Lk)("b",{class:"text-h5"},"2"),(0,s.eW)(" Active ")])],-1))])]),_:1}),t[7]||(t[7]=(0,s.Lk)("p",{class:"textt text-white text-h5"},"Devices",-1)),(0,s.Lk)("div",p,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(D.devices,e=>((0,s.uX)(),(0,s.Wv)(F,{class:"cardd bg-dark q-pa-md",key:e.mac_address},{default:(0,s.k6)(()=>[(0,s.Lk)("div",v,[(0,s.Lk)("div",null,[(0,s.Lk)("div",f,(0,i.v_)(e.device_name),1),(0,s.Lk)("div",k,[(0,s.bF)(F,{class:(0,i.C4)([q.getTempBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(A,{name:"device_thermostat",size:"40px"}),(0,s.Lk)("p",y,(0,i.v_)(q.getTemperature(e.data))+"°C ",1)]),_:2},1032,["class"]),(0,s.bF)(F,{class:(0,i.C4)([q.getFireBadge(e.data),"col q-pa-md cardd column items-center"])},{default:(0,s.k6)(()=>[(0,s.bF)(A,{name:"local_fire_department",size:"40px"}),(0,s.Lk)("p",b,(0,i.v_)(q.getFirestate(e.data)),1)]),_:2},1032,["class"])]),(0,s.Lk)("div",w,[(0,s.bF)(S,{label:"See details",color:"dark",unelevated:"",class:"col button-cuy text-capitalize text-white",onClick:t=>q.goToDetailPage(e.mac_address)},null,8,["onClick"]),(0,s.bF)(S,{label:"Ask AI Assistant",unelevated:"",color:"dark",class:"col button-cuy text-capitalize text-white",onClick:t=>q.askAIForDevice(e.mac_address),loading:D.loadingDevices[e.mac_address]||!1,style:{width:"290px"}},null,8,["onClick","loading"])])])]),D.answers[e.mac_address]?((0,s.uX)(),(0,s.Wv)(I,{key:0},{default:(0,s.k6)(()=>[(0,s.bF)(F,{class:"bg-dark q-pa-md text-white"},{default:(0,s.k6)(()=>[(0,s.Lk)("div",_,[t[5]||(t[5]=(0,s.Lk)("strong",{class:"text-h6"},"AI RESPONSE",-1)),(0,s.bF)(S,{dense:"",flat:"",icon:"close",color:"white",onClick:t=>q.removeAnswer(e.mac_address),"aria-label":"Close answer"},null,8,["onClick"])]),(0,s.Lk)("div",x,(0,i.v_)(D.answers[e.mac_address]),1)]),_:2},1024)]),_:2},1024)):(0,s.Q3)("",!0)]),_:2},1024))),128))])]),_:1,__:[6,7]}))}a(310),a(2203),a(95);const D={name:"UserDevices",data(){return{loadingLogs:!1,showDialog:!1,userPrompt:"",answers:{},loadingDevices:{},loading:!1,pagination:{page:1,rowsPerPage:25,rowsNumber:0,sortBy:"",descending:!1},audioAllowed:!1,devices:[],userId:null,detailDialog:!1,historyDialog:!1,selectedDevice:null,selectedHistoryDevice:null,zoom:15,status:"",deviceLogs:[],columns:[{name:"log_value",label:"Temperature (°C)",field:"log_value",sortable:!0,format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.temperature?a.temperature+" °C":"-"}catch{return"-"}}},{name:"log_value",label:"Status",field:"log_value",format:e=>{try{const t="string"===typeof e.data?e.data:JSON.stringify(e.data),a=JSON.parse(t);return void 0!==a.status?a.status:"-"}catch{return"-"}}},{name:"created_at",label:"Created At (WIB)",field:"created_at",format:e=>{if(!e)return"-";try{const t=new Date(e);return new Intl.DateTimeFormat("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Jakarta"}).format(t)}catch{return e}},sortable:!0}]}},watch:{status(e){this.showBrowserNotification("Test","Ini push notifikasi!")}},mounted(){const e=JSON.parse(localStorage.getItem("user"));this.userId=e?.id_user||null,this.fetchDevices(),this.fetchAndAsk(),this.requestNotificationPermission(),this.intervalId=setInterval(()=>{this.fetchDevices()},2e3)},beforeUnmount(){clearInterval(this.intervalId)},computed:{hasLocation(){return this.selectedDevice&&null!=this.selectedDevice.latitude&&null!=this.selectedDevice.longitude},mapCenter(){return this.hasLocation?[this.selectedDevice.latitude,this.selectedDevice.longitude]:[0,0]}},methods:{goToDetailPage(e){this.$router.push({name:"DEVICEDETAILS",params:{mac_address:e}})},async fetchDevices(){if(this.userId)try{const e=localStorage.getItem("token"),t=await this.$api.get(`/devices/realtime/${this.userId}`,{headers:{Authorization:`Bearer ${e}`}});this.devices=t.data.data||[],this.devices.forEach(e=>{e&&this.requestNotificationPermission(e)})}catch(e){this.$q.notify({type:"negative",message:"Failed to load devices",position:"top"})}else this.devices=[]},async askAIForDevice(e){const t=this.devices.find(t=>t.mac_address===e);if(t){this.loadingDevices[e]=!0,this.answers[e]="";try{const a="object"===typeof t.data?JSON.stringify(t.data):t.data,s=`\nHere is the sensor data from an IoT device: ${a}\n\nPlease do the following:\n1. Analyze the data thoroughly for any signs of fire, smoke, or other hazards.\n2. Provide a clear and concise explanation regarding any risks detected.\n3. Suggest appropriate actions or solutions to mitigate these risks.\n\nLimit your entire response to between 300 and 400 characters only.\n`,i=await this.$api.post("/openai/ask",{prompt:s});this.answers[e]=i.data.answer}catch(t){this.answers[e]="Gagal mendapatkan jawaban AI.",console.error(t)}finally{this.loadingDevices[e]=!1}}},async fetchAndAsk(){await this.fetchDevices(),await this.askAIOnDevices()},onToggleAudio(e){e?this.$q.notify({message:"Suara notifikasi telah diaktifkan",color:"positive",position:"top"}):this.$q.notify({message:"Suara notifikasi dimatikan",color:"negative",position:"top"})},async loadDataAndStartInterval(){await this.fetchDevices(),this.intervalId=setInterval(()=>{this.fetchDevices()},2e3)},beforeUnmount(){clearInterval(this.intervalId)},openDetail(e){this.selectedDevice=e,this.detailDialog=!0},async openHistory(e){this.selectedHistoryDevice=e,this.historyDialog=!0,this.pagination.page=1,await this.fetchLogs()},async fetchLogs(){this.loadingLogs=!0;try{const e=localStorage.getItem("token"),{page:t,rowsPerPage:a,sortBy:s,descending:i}=this.pagination,r=i?"desc":"asc",o=await this.$api.get(`/device-logs/logs/${this.selectedHistoryDevice.mac_address}`,{params:{page:t,limit:a,sortBy:s,order:r},headers:{Authorization:`Bearer ${e}`}});this.deviceLogs=Array.isArray(o.data.logs)?o.data.logs:[],this.pagination.rowsNumber=o.data.total||0}catch(e){console.error("Failed to load device logs",e)}finally{this.loadingLogs=!1}},async onRequest(e){this.pagination=e.pagination,await this.fetchLogs()},async onDeleteHistory(){if(this.selectedHistoryDevice&&this.selectedHistoryDevice.mac_address)try{this.loadingLogs=!0,await this.$api.delete(`/device-logs/logs/${this.selectedHistoryDevice.mac_address}`),this.$q.notify({type:"positive",message:"Device history deleted successfully"}),this.deviceLogs=[]}catch(e){this.$q.notify({type:"negative",message:"Failed to delete device history"})}finally{this.loadingLogs=!1}else this.$q.notify({type:"warning",message:"No device selected to delete history"})},removeAnswer(e){delete this.answers[e],this.answers={...this.answers}},getTemperature(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.temperature?parseFloat(t.temperature).toFixed(2):"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getTempBadge(e){const t=this.getTemperature(e);return t<40?"bg-green":t<60?"bg-orange":"bg-negative"},getFireNotif(e){if(!e||!e.data||!e.data.data)return"-";try{const t="string"===typeof e.data.data?JSON.parse(e.data.data):e.data.data;return void 0!==t.api?t.api:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getFirestate(e){if(!e)return"-";if(e.data){if("string"!==typeof e.data)return"object"===typeof e.data&&null!==e.data&&void 0!==e.data.api?e.data.api:"-";try{const t=JSON.parse(e.data);return void 0!==t.api?t.api:"-"}catch(e){return console.error("JSON parse error:",e),"-"}}else if(void 0!==e.api)return e.api;return"-"},getFireBadge(e){const t=this.getFirestate(e);return"fire detected!"===t?"bg-negative":"no fire"===t?"bg-green":"bg-grey"},getSirenstate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.relay?t.relay:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSirenbadge(e){const t=this.getSirenstate(e);return"ON"===t?"bg-negative":"OFF"===t?"bg-green":"bg-grey"},getSmokestate(e){if(!e||!e.data)return"-";try{const t="string"===typeof e.data?JSON.parse(e.data):e.data;return void 0!==t.smoke?t.smoke:"-"}catch(e){return console.error("JSON parse error:",e),"-"}},getSmokebadge(e){const t=this.getSmokestate(e);return"smoke detected!"===t?"bg-negative":"no smoke"===t?"bg-green":"bg-grey"},async requestNotificationPermission(e){if(e&&"Notification"in window){const t=await Notification.requestPermission();if("granted"===t){const t=this.getFireNotif(e),a=t.toString().toLowerCase().trim();if("fire detected!"===a||"fire hazard"===a){const t=`🔥 Fire detected pada device: ${e.device_name||"Unknown"}. Segera ambil tindakan!`;if(new Notification("ALERT NOTIFICATION",{body:t,icon:"/icons/icon-192x192.png"}),this.audioAllowed){const e=new Audio("/sounds/alarm.mp3");e.play().catch(e=>{console.warn("Audio play gagal:",e)})}}}else console.warn("Izin notifikasi ditolak")}},showBrowserNotification(e,t){"Notification"in window&&"granted"===Notification.permission&&new Notification(e,{body:t})}}};var q=a(2807),A=a(7716),F=a(3316),S=a(492),I=a(6908),N=a(3954),C=a(1693),O=a(4189),T=a(8582),$=a.n(T);const z=(0,q.A)(D,[["render",L]]),J=z;$()(D,"components",{QPage:A.A,QCard:F.A,QIcon:S.A,QToggle:I.A,QBadge:N.A,QBtn:C.A,QCardSection:O.A})}}]);